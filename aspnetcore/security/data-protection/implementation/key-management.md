---
title: Administración de claves en ASP.NET Core
author: rick-anderson
description: Obtenga información sobre la implementación de las API de administración de claves de protección de datos ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
no-loc:
- ':::no-loc(appsettings.json):::'
- ':::no-loc(ASP.NET Core Identity):::'
- ':::no-loc(cookie):::'
- ':::no-loc(Cookie):::'
- ':::no-loc(Blazor):::'
- ':::no-loc(Blazor Server):::'
- ':::no-loc(Blazor WebAssembly):::'
- ':::no-loc(Identity):::'
- ":::no-loc(Let's Encrypt):::"
- ':::no-loc(Razor):::'
- ':::no-loc(SignalR):::'
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: f7e0fa5e80208469188a11239a9453ecafdcf5f3
ms.sourcegitcommit: ca34c1ac578e7d3daa0febf1810ba5fc74f60bbf
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 10/30/2020
ms.locfileid: "93060201"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="7c02f-103">Administración de claves en ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="7c02f-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="7c02f-104">El sistema de protección de datos administra automáticamente la duración de las claves maestras utilizadas para proteger y desproteger las cargas.</span><span class="sxs-lookup"><span data-stu-id="7c02f-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="7c02f-105">Cada clave puede existir en una de estas cuatro fases:</span><span class="sxs-lookup"><span data-stu-id="7c02f-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="7c02f-106">Creado: la clave existe en el anillo de claves, pero aún no se ha activado.</span><span class="sxs-lookup"><span data-stu-id="7c02f-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="7c02f-107">La clave no debe usarse para nuevas operaciones de protección hasta que haya transcurrido el tiempo suficiente para que la clave haya tenido la oportunidad de propagarse a todas las máquinas que están consumiendo este anillo de claves.</span><span class="sxs-lookup"><span data-stu-id="7c02f-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="7c02f-108">Activo: la clave existe en el anillo de claves y se debe usar para todas las nuevas operaciones de protección.</span><span class="sxs-lookup"><span data-stu-id="7c02f-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="7c02f-109">Expired: la clave ha ejecutado su duración natural y ya no debe usarse para nuevas operaciones de protección.</span><span class="sxs-lookup"><span data-stu-id="7c02f-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="7c02f-110">Revocado: la clave está en peligro y no debe usarse para nuevas operaciones de protección.</span><span class="sxs-lookup"><span data-stu-id="7c02f-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="7c02f-111">Las claves creadas, activas y expiradas se pueden usar para desproteger las cargas entrantes.</span><span class="sxs-lookup"><span data-stu-id="7c02f-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="7c02f-112">De forma predeterminada, las claves revocadas no se pueden usar para desproteger las cargas, pero el desarrollador de la aplicación puede [invalidar este comportamiento](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) si es necesario.</span><span class="sxs-lookup"><span data-stu-id="7c02f-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="7c02f-113">El desarrollador podría verse tentado a eliminar una clave del anillo de claves (por ejemplo, eliminando el archivo correspondiente del sistema de archivos).</span><span class="sxs-lookup"><span data-stu-id="7c02f-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="7c02f-114">En ese momento, todos los datos protegidos por la clave son permanentemente descifrables y no hay ninguna invalidación de emergencia como sucede con las claves revocadas.</span><span class="sxs-lookup"><span data-stu-id="7c02f-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="7c02f-115">La eliminación de una clave es realmente un comportamiento destructivo y, por consiguiente, el sistema de protección de datos no expone ninguna API de primera clase para realizar esta operación.</span><span class="sxs-lookup"><span data-stu-id="7c02f-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="7c02f-116">Selección de clave predeterminada</span><span class="sxs-lookup"><span data-stu-id="7c02f-116">Default key selection</span></span>

<span data-ttu-id="7c02f-117">Cuando el sistema de protección de datos lee el anillo de claves del repositorio de respaldo, intentará buscar una clave "predeterminada" desde el anillo de claves.</span><span class="sxs-lookup"><span data-stu-id="7c02f-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="7c02f-118">La clave predeterminada se usa para las nuevas operaciones de protección.</span><span class="sxs-lookup"><span data-stu-id="7c02f-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="7c02f-119">La heurística general es que el sistema de protección de datos elige la clave con la fecha de activación más reciente como la clave predeterminada.</span><span class="sxs-lookup"><span data-stu-id="7c02f-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="7c02f-120">(Hay un factor de Fudge pequeño para permitir el sesgo de reloj entre servidores). Si la clave ha expirado o se ha revocado, y si la aplicación no ha deshabilitado la generación automática de claves, se generará una nueva clave con la activación inmediata según la Directiva de [expiración de clave y](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) la Directiva gradual siguiente.</span><span class="sxs-lookup"><span data-stu-id="7c02f-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="7c02f-121">El motivo por el que el sistema de protección de datos genera una nueva clave inmediatamente en lugar de revertir a una clave diferente es que la nueva generación de claves debe tratarse como una expiración implícita de todas las claves que se activaron antes de la nueva clave.</span><span class="sxs-lookup"><span data-stu-id="7c02f-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="7c02f-122">La idea general es que las nuevas claves se hayan configurado con distintos algoritmos o mecanismos de cifrado en reposo que las claves antiguas, y el sistema debe preferir la configuración actual en lugar de revertirla.</span><span class="sxs-lookup"><span data-stu-id="7c02f-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="7c02f-123">Hay una excepción.</span><span class="sxs-lookup"><span data-stu-id="7c02f-123">There's an exception.</span></span> <span data-ttu-id="7c02f-124">Si el desarrollador de la aplicación ha [deshabilitado la generación automática de claves](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), el sistema de protección de datos debe elegir algo como clave predeterminada.</span><span class="sxs-lookup"><span data-stu-id="7c02f-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="7c02f-125">En este escenario de reserva, el sistema elegirá la clave no revocada con la fecha de activación más reciente, con preferencia a las claves que han tenido tiempo de propagarse a otras máquinas del clúster.</span><span class="sxs-lookup"><span data-stu-id="7c02f-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="7c02f-126">El sistema de reserva puede acabar eligiendo una clave predeterminada caducada como resultado.</span><span class="sxs-lookup"><span data-stu-id="7c02f-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="7c02f-127">El sistema de reserva nunca elegirá una clave revocada como clave predeterminada y, si el anillo de claves está vacío o se ha revocado cada clave, el sistema generará un error tras la inicialización.</span><span class="sxs-lookup"><span data-stu-id="7c02f-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="7c02f-128">Expiración de clave y gradual</span><span class="sxs-lookup"><span data-stu-id="7c02f-128">Key expiration and rolling</span></span>

<span data-ttu-id="7c02f-129">Cuando se crea una clave, se le asigna automáticamente una fecha de activación de {Now + 2 días} y una fecha de expiración de {Now + 90 días}.</span><span class="sxs-lookup"><span data-stu-id="7c02f-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="7c02f-130">El retraso de 2 días antes de la activación proporciona el tiempo clave para propagarse a través del sistema.</span><span class="sxs-lookup"><span data-stu-id="7c02f-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="7c02f-131">Es decir, permite que otras aplicaciones que apuntan a la memoria auxiliar observen la clave en el siguiente período de actualización automática, lo que maximiza el riesgo de que cuando el anillo de claves se active, se propague a todas las aplicaciones que puedan necesitar usarlo.</span><span class="sxs-lookup"><span data-stu-id="7c02f-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="7c02f-132">Si la clave predeterminada expirará en un plazo de 2 días y el anillo de claves aún no tiene una clave que esté activa cuando expire la clave predeterminada, el sistema de protección de datos conservará automáticamente una nueva clave en el anillo de claves.</span><span class="sxs-lookup"><span data-stu-id="7c02f-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="7c02f-133">Esta nueva clave tiene una fecha de activación de {fecha de expiración de la clave predeterminada} y una fecha de expiración de {Now + 90 días}.</span><span class="sxs-lookup"><span data-stu-id="7c02f-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="7c02f-134">Esto permite al sistema revertir las claves de forma periódica sin interrupción del servicio.</span><span class="sxs-lookup"><span data-stu-id="7c02f-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="7c02f-135">Puede haber circunstancias en las que se creará una clave con activación inmediata.</span><span class="sxs-lookup"><span data-stu-id="7c02f-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="7c02f-136">Un ejemplo sería cuando la aplicación no se ha ejecutado durante un tiempo y todas las claves del anillo de claves han expirado.</span><span class="sxs-lookup"><span data-stu-id="7c02f-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="7c02f-137">Cuando esto sucede, a la clave se le asigna una fecha de activación de {Now} sin el retraso de activación de 2 días normal.</span><span class="sxs-lookup"><span data-stu-id="7c02f-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="7c02f-138">La duración de la clave predeterminada es de 90 días, aunque se puede configurar como en el ejemplo siguiente.</span><span class="sxs-lookup"><span data-stu-id="7c02f-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="7c02f-139">Un administrador también puede cambiar el valor predeterminado de todo el sistema, aunque una llamada explícita a `SetDefaultKeyLifetime` invalidará cualquier directiva de todo el sistema.</span><span class="sxs-lookup"><span data-stu-id="7c02f-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="7c02f-140">La duración de la clave predeterminada no puede ser inferior a 7 días.</span><span class="sxs-lookup"><span data-stu-id="7c02f-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="7c02f-141">Actualización automática de Key Ring</span><span class="sxs-lookup"><span data-stu-id="7c02f-141">Automatic key ring refresh</span></span>

<span data-ttu-id="7c02f-142">Cuando el sistema de protección de datos se inicializa, lee el anillo de claves del repositorio subyacente y lo almacena en memoria caché.</span><span class="sxs-lookup"><span data-stu-id="7c02f-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="7c02f-143">Esta memoria caché permite que las operaciones de protección y desprotección continúen sin tener que golpear la memoria auxiliar.</span><span class="sxs-lookup"><span data-stu-id="7c02f-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="7c02f-144">El sistema comprobará automáticamente la memoria auxiliar de los cambios aproximadamente cada 24 horas o cuando expire la clave predeterminada actual, lo que suceda primero.</span><span class="sxs-lookup"><span data-stu-id="7c02f-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="7c02f-145">En raras ocasiones, los desarrolladores deben usar las API de administración de claves directamente.</span><span class="sxs-lookup"><span data-stu-id="7c02f-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="7c02f-146">El sistema de protección de datos llevará a cabo la administración automática de claves como se describió anteriormente.</span><span class="sxs-lookup"><span data-stu-id="7c02f-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="7c02f-147">El sistema de protección de datos expone una interfaz `IKeyManager` que se puede usar para inspeccionar y realizar cambios en el anillo de claves.</span><span class="sxs-lookup"><span data-stu-id="7c02f-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="7c02f-148">El sistema DI que proporcionó la instancia de `IDataProtectionProvider` también puede proporcionar una instancia de `IKeyManager` para su consumo.</span><span class="sxs-lookup"><span data-stu-id="7c02f-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="7c02f-149">Como alternativa, puede extraer el `IKeyManager` directo de `IServiceProvider` como en el ejemplo siguiente.</span><span class="sxs-lookup"><span data-stu-id="7c02f-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="7c02f-150">Cualquier operación que modifique el anillo clave (al crear una nueva clave explícitamente o realizar una revocación) invalidará la caché en memoria.</span><span class="sxs-lookup"><span data-stu-id="7c02f-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="7c02f-151">La siguiente llamada a `Protect` o hará `Unprotect` que el sistema de protección de datos vuelva a leer el anillo de claves y vuelva a crear la memoria caché.</span><span class="sxs-lookup"><span data-stu-id="7c02f-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="7c02f-152">En el ejemplo siguiente se muestra cómo usar la `IKeyManager` interfaz para inspeccionar y manipular el anillo de claves, incluida la revocación de las claves existentes y la generación manual de una nueva clave.</span><span class="sxs-lookup"><span data-stu-id="7c02f-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

[!INCLUDE[about the series](~/includes/code-comments-loc.md)]

## <a name="key-storage"></a><span data-ttu-id="7c02f-153">Almacenamiento de claves</span><span class="sxs-lookup"><span data-stu-id="7c02f-153">Key storage</span></span>

<span data-ttu-id="7c02f-154">El sistema de protección de datos tiene una heurística en la que intenta deducir automáticamente una ubicación de almacenamiento de claves adecuada y el mecanismo de cifrado en reposo.</span><span class="sxs-lookup"><span data-stu-id="7c02f-154">The data protection system has a heuristic whereby it attempts to deduce an appropriate key storage location and encryption-at-rest mechanism automatically.</span></span> <span data-ttu-id="7c02f-155">El desarrollador de la aplicación también puede configurar el mecanismo de persistencia de claves.</span><span class="sxs-lookup"><span data-stu-id="7c02f-155">The key persistence mechanism is also configurable by the app developer.</span></span> <span data-ttu-id="7c02f-156">En los documentos siguientes se describen las implementaciones integradas de estos mecanismos:</span><span class="sxs-lookup"><span data-stu-id="7c02f-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* <xref:security/data-protection/implementation/key-storage-providers>
* <xref:security/data-protection/implementation/key-encryption-at-rest>
